name: Deploy
on: [push]
#   pull_request:
#     branches:
#       - test/pipeline-mergeInto
#     types: [closed]
env:
   XCODE_VERSION: '13.0'
   SCHEME_NAME: 'EhPanda'
   SIMULATOR_IDENTIFIER: 'iPhone 12'
   BUILDS_PATH: '/tmp/action-builds'
   ARCHIVE_PATH: '/tmp/action-builds/EhPanda.xcarchive'
   APP_DEV_PROVISION_PATH: '/tmp/action-builds/app_dev.mobileprovision'
   DEV_CERTIFICATE_PATH: '/tmp/action-builds/dev.p12'
   KEYCHAIN_PATH: '/tmp/action-builds/generated.keychain'
   APP_DEV_PROVISION_BASE64: ${{ secrets.APP_DEV_PROVISION }}
   DEV_CERTIFICATE_BASE64: ${{ secrets.DEV_CERTIFICATE }}
   DEV_CERTIFICATE_PASSWORD: ${{ secrets.DEV_CERTIFICATE_PASSWORD }}
jobs:
  Deploy:
    runs-on: macos-11
#     if: github.event.pull_request.merged == true
#       && github.event.pull_request.user.login == 'tatsuz0u'
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Select Xcode
        run: sudo xcode-select --switch /Applications/Xcode_${{ env.XCODE_VERSION }}.app
      - name: Show Xcode version
        run: xcodebuild -version
#       - name: Run tests
#         run: xcodebuild
#           -scheme ${{ env.SCHEME_NAME }} -sdk iphonesimulator
#           -destination 'platform=iOS Simulator,name=${{ env.SIMULATOR_IDENTIFIER }}'
#           clean test
      - name: Install provison file
        run: |
          mkdir $BUILDS_PATH
          echo -n "$APP_DEV_PROVISION_BASE64" | base64 -d -o $APP_DEV_PROVISION_PATH
          echo -n "$DEV_CERTIFICATE_BASE64" | base64 -d -o $DEV_CERTIFICATE_PATH
 
          security create-keychain -p $DEV_CERTIFICATE_PASSWORD $KEYCHAIN_PATH
          security list-keychains -s $KEYCHAIN_PATH
          security default-keychain -s $KEYCHAIN_PATH
          security unlock-keychain -p $DEV_CERTIFICATE_PASSWORD $KEYCHAIN_PATH
          security set-keychain-settings

          security import $DEV_CERTIFICATE_PATH -P $DEV_CERTIFICATE_PASSWORD -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k $DEV_CERTIFICATE_PASSWORD $KEYCHAIN_PATH
          
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $APP_DEV_PROVISION_PATH ~/Library/MobileDevice/Provisioning\ Profiles
      - name: Xcode archive
        run: xcodebuild
          -scheme ${{ env.SCHEME_NAME }} -archivePath ${{ env.ARCHIVE_PATH }}
          -destination 'generic/platform=iOS'
          "OTHER_CODE_SIGN_FLAGS=--keychain '$KEYCHAIN_PATH'"
          archive
