name: Deploy
on: [push]
#   pull_request:
#     branches:
#       - test/pipeline-mergeInto
#     types: [closed]
env:
   DEVELOPER_DIR: /Applications/Xcode_13.0.app
   APP_VERSION: '1.0.4'
   SCHEME_NAME: 'EhPanda'
   SIMULATOR_IDENTIFIER: 'iPhone 12'
   BUILDS_PATH: '/tmp/action-builds'
   ARCHIVE_PATH: '/tmp/action-builds/EhPanda.xcarchive'
   IPA_OUTPUT_PATH: '/tmp/action-builds/EhPanda.ipa'
   EXPORT_PLIST_PATH: './ExportOptions.plist'
   DEV_CERTIFICATE_PATH: '/tmp/action-builds/dev.cer'
   DIS_CERTIFICATE_PATH: '/tmp/action-builds/dis.cer'
   DEV_P12_PATH: '/tmp/action-builds/dev.p12'
   DIS_P12_PATH: '/tmp/action-builds/dis.p12'
   APP_DEV_PROVISION_PATH: '/tmp/action-builds/app_dev.mobileprovision'
   APP_DIS_PROVISION_PATH: '/tmp/action-builds/app_dis.mobileprovision'
   SHARE_EXTENSION_DEV_PROVISION_PATH: '/tmp/action-builds/share_extension_dev.mobileprovision'
   SHARE_EXTENSION_DIS_PROVISION_PATH: '/tmp/action-builds/share_extension_dis.mobileprovision'
jobs:
  Deploy:
    runs-on: macos-11
#     if: github.event.pull_request.merged == true
#       && github.event.pull_request.user.login == 'tatsuz0u'
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Modify git config
        run: |
           git config user.name "github-actions[bot]"
           git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
#       - name: Run tests
#         run: xcodebuild clean test -scheme ${{ env.SCHEME_NAME }} -sdk iphonesimulator
#           -destination 'platform=iOS Simulator,name=${{ env.SIMULATOR_IDENTIFIER }}'
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Decode certificates and provisioning profiles
        env: 
          DEV_CERTIFICATE_BASE64: ${{ secrets.DEV_CERTIFICATE }}
          DIS_CERTIFICATE_BASE64: ${{ secrets.DIS_CERTIFICATE }}
          DEV_P12_BASE64: ${{ secrets.DEV_P12 }}
          DIS_P12_BASE64: ${{ secrets.DIS_P12 }}
          APP_DEV_PROVISION_BASE64: ${{ secrets.APP_DEV_PROVISION }}
          APP_DIS_PROVISION_BASE64: ${{ secrets.APP_DIS_PROVISION }}
          SHARE_EXTENSION_DEV_PROVISION_BASE64: ${{ secrets.SHARE_EXTENSION_DEV_PROVISION }}
          SHARE_EXTENSION_DIS_PROVISION_BASE64: ${{ secrets.SHARE_EXTENSION_DIS_PROVISION }}
        run: |
          mkdir $BUILDS_PATH
          echo -n "$DEV_CERTIFICATE_BASE64" | base64 -d -o $DEV_CERTIFICATE_PATH
          echo -n "$DIS_CERTIFICATE_BASE64" | base64 -d -o $DIS_CERTIFICATE_PATH
          echo -n "$DEV_P12_BASE64" | base64 -d -o $DEV_P12_PATH
          echo -n "$DIS_P12_BASE64" | base64 -d -o $DIS_P12_PATH
          echo -n "$APP_DEV_PROVISION_BASE64" | base64 -d -o $APP_DEV_PROVISION_PATH
          echo -n "$APP_DIS_PROVISION_BASE64" | base64 -d -o $APP_DIS_PROVISION_PATH
          echo -n "$SHARE_EXTENSION_DEV_PROVISION_BASE64" | base64 -d -o $SHARE_EXTENSION_DEV_PROVISION_PATH
          echo -n "$SHARE_EXTENSION_DIS_PROVISION_BASE64" | base64 -d -o $SHARE_EXTENSION_DIS_PROVISION_PATH
      - name: Install certificates
        env:
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          KEY_CHAIN=action-builds.keychain-db
 
          security create-keychain -p $P12_PASSWORD $KEY_CHAIN
          security default-keychain -s $KEY_CHAIN
          security unlock-keychain -p $P12_PASSWORD $KEY_CHAIN
          security set-keychain-settings -t 3600 -u $KEY_CHAIN

          security import $DEV_CERTIFICATE_PATH -k $KEY_CHAIN -T /usr/bin/codesign
          security import $DIS_CERTIFICATE_PATH -k $KEY_CHAIN -T /usr/bin/codesign
          security import $DEV_P12_PATH -k $KEY_CHAIN -P $P12_PASSWORD -T /usr/bin/codesign
          security import $DIS_P12_PATH -k $KEY_CHAIN -P $P12_PASSWORD -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k $P12_PASSWORD ~/Library/Keychains/action-builds.keychain-db
          
          security list-keychains
          security find-identity -p codesigning  ~/Library/Keychains/action-builds.keychain-db
      - name: Install provisioning profiles
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          app_dev_uuid=`grep UUID -A1 -a $APP_DEV_PROVISION_PATH | grep -io "[-A-F0-9]\{36\}"`
          app_dis_uuid=`grep UUID -A1 -a $APP_DIS_PROVISION_PATH | grep -io "[-A-F0-9]\{36\}"`
          share_extension_dev_uuid=`grep UUID -A1 -a $SHARE_EXTENSION_DEV_PROVISION_PATH | grep -io "[-A-F0-9]\{36\}"`
          share_extension_dis_uuid=`grep UUID -A1 -a $SHARE_EXTENSION_DIS_PROVISION_PATH | grep -io "[-A-F0-9]\{36\}"`
          cp $APP_DEV_PROVISION_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$app_dev_uuid.mobileprovision
          cp $APP_DIS_PROVISION_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$app_dis_uuid.mobileprovision
          cp $SHARE_EXTENSION_DEV_PROVISION_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$share_extension_dev_uuid.mobileprovision
          cp $SHARE_EXTENSION_DIS_PROVISION_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$share_extension_dis_uuid.mobileprovision
          ls ~/Library/MobileDevice/Provisioning\ Profiles
      - name: Bump version
        uses: yanamura/ios-bump-version@v1
        with:
          version: ${{ env.APP_VERSION }}
      - name: Xcode archive
        run: xcodebuild archive -destination 'generic/platform=iOS'
          -scheme ${{ env.SCHEME_NAME }} -archivePath ${{ env.ARCHIVE_PATH }}
      - name: Generate .ipa file
        run: xcodebuild -exportArchive 
          -archivePath ${{ env.ARCHIVE_PATH }} 
          -exportPath ${{ env.BUILDS_PATH }}
          -exportOptionsPlist ${{ env.EXPORT_PLIST_PATH }}
      - name: Rename .ipa file
        run: mv ${{ env.BUILDS_PATH }}/*.ipa ${{ env.IPA_OUTPUT_PATH }}
      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        with:
         token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
         files: ${{ env.IPA_OUTPUT_PATH }}
         tag_name: 'test'
         prerelease: true
         fail_on_unmatched_files: true
         body: 'This is a test build released by bot, do not download.'
      - name: Commit bump version
        run: |
          git add .
          git commit -m "Bump version"
          git push origin HEAD
