name: Deploy
on: [push]
#   pull_request:
#     branches:
#       - test/pipeline-mergeInto
#     types: [closed]
env:
   XCODE_VERSION: '13.0'
   SCHEME_NAME: 'EhPanda'
   AUTHORIZED_AUTHOR: 'tatsuz0u'
   SIMULATOR_IDENTIFIER: 'iPhone 12'
   BUILDS_PATH: '/Builds'
   ARCHIVE_PATH: '${{ BUILDS_PATH }}/${{ SCHEME_NAME }}.xcarchive'
jobs:
  Build-and-test:
    runs-on: macos-11
    if: github.event.pull_request.merged == true
      && github.event.pull_request.user.login == ${{ env.AUTHORIZED_AUTHOR }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Select Xcode
        run: sudo xcode-select --switch /Applications/Xcode_${{ env.XCODE_VERSION }}.app
      - name: Show Xcode version
        run: xcodebuild -version
      - name: Run tests
        run: xcodebuild
          -scheme ${{ env.SCHEME_NAME }} -sdk iphonesimulator
          -destination 'platform=iOS Simulator,name=${{ env.SIMULATOR_IDENTIFIER }}'
          clean test
      - name: Xcode archive
        run: xcodebuild
          -scheme ${{ env.SCHEME_NAME }} -archivePath ${{ env.ARCHIVE_PATH }} 
          archive
